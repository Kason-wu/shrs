import { BookingService, BookingRecord, BookingStatus, Museum, TimeSlot } from '../services/BookingService';
import { ReminderService } from '../services/ReminderService';
import { DateUtils } from '../utils/DateUtils';
import { ValidationUtils } from '../utils/ValidationUtils';

/**
 * é¢„çº¦åŠŸèƒ½æ¼”ç¤ºç±»
 * ç”¨äºå±•ç¤ºå’ŒéªŒè¯é¢„çº¦ç³»ç»Ÿçš„å„é¡¹åŠŸèƒ½
 */
export class BookingDemo {
  private bookingService: BookingService;
  private reminderService: ReminderService;

  constructor() {
    this.bookingService = BookingService.getInstance();
    this.reminderService = ReminderService.getInstance();
  }

  /**
   * åˆå§‹åŒ–æ¼”ç¤ºæ•°æ®
   */
  initDemoData(): void {
    console.info('=== åˆå§‹åŒ–é¢„çº¦ç³»ç»Ÿæ¼”ç¤ºæ•°æ® ===');
    
    // æ¸…ç†ç°æœ‰æ•°æ®
    AppStorage.SetOrCreate('userBookings', []);
    AppStorage.SetOrCreate('booking_reminders', []);
    
    // åˆ›å»ºç¤ºä¾‹åšç‰©é¦†æ•°æ®
    const museums: Museum[] = [
      {
        id: 1,
        name: 'å›½å®¶åšç‰©é¦†',
        description: 'ä¸­å›½å†å²æ–‡åŒ–çš„é‡è¦å±•ç¤ºçª—å£',
        image: 'museum1.jpg',
        location: 'åŒ—äº¬å¸‚ä¸œåŸåŒº',
        rating: 4.8,
        price: 0,
        openTime: '09:00-17:00',
        tags: ['å†å²', 'æ–‡ç‰©', 'å…è´¹'],
        distance: '2.3km'
      },
      {
        id: 2,
        name: 'æ•…å®«åšç‰©é™¢',
        description: 'æ˜æ¸…ä¸¤ä»£çš„çš‡å®¶å®«æ®¿',
        image: 'museum2.jpg',
        location: 'åŒ—äº¬å¸‚ä¸œåŸåŒº',
        rating: 4.9,
        price: 60,
        openTime: '08:30-17:00',
        tags: ['å†å²', 'å»ºç­‘', 'æ”¶è´¹'],
        distance: '1.8km'
      },
      {
        id: 3,
        name: 'ä¸­å›½ç§‘æŠ€é¦†',
        description: 'ç°ä»£ç§‘æŠ€çš„å±•ç¤ºå¹³å°',
        image: 'museum3.jpg',
        location: 'åŒ—äº¬å¸‚æœé˜³åŒº',
        rating: 4.6,
        price: 30,
        openTime: '09:30-17:00',
        tags: ['ç§‘æŠ€', 'äº’åŠ¨', 'æ”¶è´¹'],
        distance: '5.2km'
      }
    ];

    console.info(`åˆ›å»ºäº† ${museums.length} ä¸ªç¤ºä¾‹åšç‰©é¦†`);
  }

  /**
   * æ¼”ç¤ºé¢„çº¦åˆ›å»ºæµç¨‹
   */
  async demonstrateBookingCreation(): Promise<void> {
    console.info('=== æ¼”ç¤ºé¢„çº¦åˆ›å»ºæµç¨‹ ===');

    const tomorrow = DateUtils.formatDate(new Date(Date.now() + 24 * 60 * 60 * 1000));
    
    const testBookingData = {
      museum: {
        id: 1,
        name: 'å›½å®¶åšç‰©é¦†',
        description: 'ä¸­å›½å†å²æ–‡åŒ–çš„é‡è¦å±•ç¤ºçª—å£',
        image: 'museum1.jpg',
        location: 'åŒ—äº¬å¸‚ä¸œåŸåŒº',
        rating: 4.8,
        price: 0,
        openTime: '09:00-17:00',
        tags: ['å†å²', 'æ–‡ç‰©', 'å…è´¹'],
        distance: '2.3km'
      },
      date: tomorrow,
      timeSlot: {
        id: 'slot_1',
        time: '09:00-10:00',
        available: 50,
        total: 50,
        isAvailable: true
      },
      visitorCount: 2,
      visitorName: 'å¼ ä¸‰',
      visitorPhone: '13800138000',
      visitorIdCard: '110101199001011234',
      totalPrice: 0
    };

    console.info('1. éªŒè¯é¢„çº¦æ•°æ®...');
    const isValid = this.validateBookingData(testBookingData);
    console.info(`æ•°æ®éªŒè¯ç»“æœ: ${isValid ? 'é€šè¿‡' : 'å¤±è´¥'}`);

    if (isValid) {
      console.info('2. åˆ›å»ºé¢„çº¦...');
      const result = await this.bookingService.createBooking(testBookingData);
      
      if (result.success) {
        console.info(`é¢„çº¦åˆ›å»ºæˆåŠŸ! é¢„çº¦ID: ${result.booking?.id}`);
        console.info(`é¢„çº¦çŠ¶æ€: ${result.booking?.status}`);
        console.info(`é¢„çº¦æ—¶é—´: ${result.booking?.bookingTime}`);
        
        // æ¼”ç¤ºæé†’è®¾ç½®
        if (result.booking) {
          console.info('3. è®¾ç½®é¢„çº¦æé†’...');
          this.reminderService.setBookingReminder(result.booking);
          const reminders = this.reminderService.getBookingReminders(result.booking.id);
          console.info(`è®¾ç½®äº† ${reminders.length} ä¸ªæé†’`);
        }
      } else {
        console.error(`é¢„çº¦åˆ›å»ºå¤±è´¥: ${result.error}`);
      }
    }
  }

  /**
   * æ¼”ç¤ºé¢„çº¦æŸ¥è¯¢å’Œç­›é€‰
   */
  demonstrateBookingQuery(): void {
    console.info('=== æ¼”ç¤ºé¢„çº¦æŸ¥è¯¢å’Œç­›é€‰ ===');

    console.info('1. è·å–æ‰€æœ‰é¢„çº¦...');
    const allBookings = this.bookingService.getAllBookings();
    console.info(`æ€»é¢„çº¦æ•°: ${allBookings.length}`);

    console.info('2. æŒ‰çŠ¶æ€ç­›é€‰é¢„çº¦...');
    const confirmedBookings = this.bookingService.getBookingsByStatus(BookingStatus.CONFIRMED);
    const completedBookings = this.bookingService.getBookingsByStatus(BookingStatus.COMPLETED);
    const cancelledBookings = this.bookingService.getBookingsByStatus(BookingStatus.CANCELLED);
    
    console.info(`å¾…å‚è§‚: ${confirmedBookings.length}`);
    console.info(`å·²å®Œæˆ: ${completedBookings.length}`);
    console.info(`å·²å–æ¶ˆ: ${cancelledBookings.length}`);

    console.info('3. è·å–å³å°†åˆ°æ¥çš„é¢„çº¦...');
    const upcomingBookings = this.bookingService.getUpcomingBookings();
    console.info(`å³å°†åˆ°æ¥çš„é¢„çº¦: ${upcomingBookings.length}`);

    console.info('4. è·å–é¢„çº¦ç»Ÿè®¡...');
    const statistics = this.bookingService.getBookingStatistics();
    console.info(`ç»Ÿè®¡ä¿¡æ¯:`, {
      æ€»é¢„çº¦: statistics.totalBookings,
      å¾…å‚è§‚: statistics.confirmedBookings,
      å·²å®Œæˆ: statistics.completedBookings,
      å·²å–æ¶ˆ: statistics.cancelledBookings,
      æ€»æ¶ˆè´¹: statistics.totalSpent,
      å¸¸è®¿é—®åšç‰©é¦†: statistics.favoriteMuseums
    });
  }

  /**
   * æ¼”ç¤ºé¢„çº¦å–æ¶ˆæµç¨‹
   */
  async demonstrateBookingCancellation(): Promise<void> {
    console.info('=== æ¼”ç¤ºé¢„çº¦å–æ¶ˆæµç¨‹ ===');

    const confirmedBookings = this.bookingService.getBookingsByStatus(BookingStatus.CONFIRMED);
    
    if (confirmedBookings.length > 0) {
      const bookingToCancel = confirmedBookings[0];
      console.info(`1. å‡†å¤‡å–æ¶ˆé¢„çº¦: ${bookingToCancel.id}`);
      console.info(`åšç‰©é¦†: ${bookingToCancel.museum.name}`);
      console.info(`å‚è§‚æ—¥æœŸ: ${bookingToCancel.date}`);

      console.info('2. æ‰§è¡Œå–æ¶ˆæ“ä½œ...');
      const result = await this.bookingService.cancelBooking(bookingToCancel.id, 'æ¼”ç¤ºå–æ¶ˆ');
      
      if (result.success) {
        console.info('é¢„çº¦å–æ¶ˆæˆåŠŸ!');
        
        // éªŒè¯çŠ¶æ€æ›´æ–°
        const updatedBooking = this.bookingService.getBookingById(bookingToCancel.id);
        console.info(`æ›´æ–°åçŠ¶æ€: ${updatedBooking?.status}`);
      } else {
        console.error(`é¢„çº¦å–æ¶ˆå¤±è´¥: ${result.error}`);
      }
    } else {
      console.info('æ²¡æœ‰å¯å–æ¶ˆçš„é¢„çº¦');
    }
  }

  /**
   * æ¼”ç¤ºæ—¶é—´æ®µæŸ¥è¯¢
   */
  demonstrateTimeSlotQuery(): void {
    console.info('=== æ¼”ç¤ºæ—¶é—´æ®µæŸ¥è¯¢ ===');

    const tomorrow = DateUtils.formatDate(new Date(Date.now() + 24 * 60 * 60 * 1000));
    const museumId = 1;

    console.info(`æŸ¥è¯¢åšç‰©é¦† ${museumId} åœ¨ ${tomorrow} çš„å¯ç”¨æ—¶é—´æ®µ...`);
    
    const timeSlots = this.bookingService.getAvailableTimeSlots(museumId, tomorrow);
    
    console.info(`æ‰¾åˆ° ${timeSlots.length} ä¸ªæ—¶é—´æ®µ:`);
    timeSlots.forEach((slot, index) => {
      console.info(`${index + 1}. ${slot.time} - å¯é¢„çº¦: ${slot.available}/${slot.total} (${slot.isAvailable ? 'å¯ç”¨' : 'ä¸å¯ç”¨'})`);
    });
  }

  /**
   * æ¼”ç¤ºæé†’åŠŸèƒ½
   */
  demonstrateReminderFeatures(): void {
    console.info('=== æ¼”ç¤ºæé†’åŠŸèƒ½ ===');

    console.info('1. è·å–æ‰€æœ‰æé†’...');
    const allReminders = this.reminderService.getAllReminders();
    console.info(`æ€»æé†’æ•°: ${allReminders.length}`);

    console.info('2. è·å–æ´»è·ƒæé†’...');
    const activeReminders = this.reminderService.getActiveReminders();
    console.info(`æ´»è·ƒæé†’æ•°: ${activeReminders.length}`);

    console.info('3. æ£€æŸ¥å¾…å¤„ç†æé†’...');
    const pendingReminders = this.reminderService.checkPendingReminders();
    console.info(`å¾…å¤„ç†æé†’æ•°: ${pendingReminders.length}`);

    console.info('4. è·å–æé†’ç»Ÿè®¡...');
    const statistics = this.reminderService.getReminderStatistics();
    console.info(`æé†’ç»Ÿè®¡:`, {
      æ€»æé†’: statistics.totalReminders,
      æ´»è·ƒæé†’: statistics.activeReminders,
      ä»Šæ—¥æé†’: statistics.todayReminders
    });

    console.info('5. è·å–æé†’è®¾ç½®...');
    const settings = this.reminderService.getReminderSettings();
    console.info(`æé†’è®¾ç½®:`, {
      é¢„çº¦ç¡®è®¤æé†’: settings.enableBookingConfirmation,
      å‚è§‚æé†’: settings.enableVisitReminder,
      æå‰åˆ†é’Ÿæ•°: settings.reminderAdvanceMinutes
    });
  }

  /**
   * æ¼”ç¤ºæ•°æ®æ¸…ç†åŠŸèƒ½
   */
  demonstrateDataCleanup(): void {
    console.info('=== æ¼”ç¤ºæ•°æ®æ¸…ç†åŠŸèƒ½ ===');

    console.info('1. æ¸…ç†è¿‡æœŸé¢„çº¦...');
    this.bookingService.cleanupExpiredBookings();
    console.info('è¿‡æœŸé¢„çº¦æ¸…ç†å®Œæˆ');

    console.info('2. æ¸…ç†è¿‡æœŸæé†’...');
    this.reminderService.cleanupExpiredReminders();
    console.info('è¿‡æœŸæé†’æ¸…ç†å®Œæˆ');
  }

  /**
   * éªŒè¯é¢„çº¦æ•°æ®
   */
  private validateBookingData(bookingData: any): boolean {
    const validations = [
      { field: 'visitorName', value: bookingData.visitorName, validator: ValidationUtils.validateName },
      { field: 'visitorPhone', value: bookingData.visitorPhone, validator: ValidationUtils.validatePhone },
      { field: 'visitorIdCard', value: bookingData.visitorIdCard, validator: ValidationUtils.validateIdCard },
      { field: 'visitorCount', value: bookingData.visitorCount, validator: ValidationUtils.validateVisitorCount }
    ];

    let isValid = true;
    validations.forEach(({ field, value, validator }) => {
      const result = validator(value);
      console.info(`${field}: ${result ? 'âœ“' : 'âœ—'}`);
      if (!result) isValid = false;
    });

    return isValid;
  }

  /**
   * è¿è¡Œå®Œæ•´æ¼”ç¤º
   */
  async runFullDemo(): Promise<void> {
    console.info('ğŸ¯ å¼€å§‹é¢„çº¦ç³»ç»ŸåŠŸèƒ½æ¼”ç¤º');
    console.info('=====================================');

    try {
      // 1. åˆå§‹åŒ–æ•°æ®
      this.initDemoData();
      
      // 2. æ¼”ç¤ºé¢„çº¦åˆ›å»º
      await this.demonstrateBookingCreation();
      
      // 3. æ¼”ç¤ºæŸ¥è¯¢åŠŸèƒ½
      this.demonstrateBookingQuery();
      
      // 4. æ¼”ç¤ºæ—¶é—´æ®µæŸ¥è¯¢
      this.demonstrateTimeSlotQuery();
      
      // 5. æ¼”ç¤ºæé†’åŠŸèƒ½
      this.demonstrateReminderFeatures();
      
      // 6. æ¼”ç¤ºå–æ¶ˆåŠŸèƒ½
      await this.demonstrateBookingCancellation();
      
      // 7. æ¼”ç¤ºæ•°æ®æ¸…ç†
      this.demonstrateDataCleanup();
      
      console.info('=====================================');
      console.info('âœ… é¢„çº¦ç³»ç»ŸåŠŸèƒ½æ¼”ç¤ºå®Œæˆ');
      
    } catch (error) {
      console.error('âŒ æ¼”ç¤ºè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
    }
  }

  /**
   * éªŒè¯ç³»ç»Ÿå®Œæ•´æ€§
   */
  validateSystemIntegrity(): boolean {
    console.info('ğŸ” éªŒè¯é¢„çº¦ç³»ç»Ÿå®Œæ•´æ€§');
    
    const checks = [
      { name: 'é¢„çº¦æœåŠ¡åˆå§‹åŒ–', test: () => this.bookingService !== null },
      { name: 'æé†’æœåŠ¡åˆå§‹åŒ–', test: () => this.reminderService !== null },
      { name: 'æ—¥æœŸå·¥å…·å¯ç”¨', test: () => DateUtils.formatDate(new Date()) !== '' },
      { name: 'éªŒè¯å·¥å…·å¯ç”¨', test: () => ValidationUtils.validatePhone('13800138000') },
      { name: 'å­˜å‚¨åŠŸèƒ½å¯ç”¨', test: () => {
        AppStorage.SetOrCreate('test_key', 'test_value');
        return AppStorage.Get('test_key') === 'test_value';
      }}
    ];

    let allPassed = true;
    checks.forEach(({ name, test }) => {
      try {
        const result = test();
        console.info(`${name}: ${result ? 'âœ“' : 'âœ—'}`);
        if (!result) allPassed = false;
      } catch (error) {
        console.error(`${name}: âœ— (é”™è¯¯: ${error})`);
        allPassed = false;
      }
    });

    console.info(`ç³»ç»Ÿå®Œæ•´æ€§éªŒè¯: ${allPassed ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}`);
    return allPassed;
  }
}